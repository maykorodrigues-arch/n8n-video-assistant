<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Agentes de IA: YouTube & N8N</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); transition: opacity 0.3s; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 900px; border-radius: 0.75rem; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: black; }
        
        .agent-accordion details[open] summary { background-color: #eef2ff; }
        .agent-accordion summary { cursor: pointer; padding: 1rem; border-radius: 0.5rem; background-color: #f9fafb; border: 1px solid #e5e7eb; transition: background-color 0.2s; }
        .agent-accordion details { margin-bottom: 1rem; }
        .output-tab { cursor: pointer; }
        .output-tab.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .output-panel { display: none; }
        .output-panel.active { display: block; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-black text-gray-900">Plataforma de Agentes de IA</h1>
            <p class="text-lg text-gray-600 mt-2">Suas ferramentas de IA para YouTube e automação N8N.</p>
            <div class="mt-4 flex justify-center gap-4">
                <button id="open-guia-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Ver Guia de Implementação N8N</button>
                <button id="open-infografico-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700 transition-colors">Ver Infográfico N8N</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div id="agent-config-column" class="bg-white p-6 rounded-lg shadow-md">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label for="gemini-api-key" class="block text-lg font-bold text-gray-800">Chave da API Gemini (Global)</label>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sm text-indigo-600 hover:underline">Obtenha sua chave aqui</a>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="gemini-api-key" class="block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-md shadow-sm" placeholder="Cole sua chave de API do Google AI Studio...">
                        <button id="save-api-key-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">Salvar</button>
                    </div>
                    <span id="api-key-status" class="text-xs text-green-700 h-4 block mt-1"></span>
                </div>
                
                <h2 class="text-2xl font-bold text-gray-900 border-b pb-2 mb-4">Agentes de Conteúdo</h2>
                <div class="agent-accordion space-y-2">
                    </div>
            </div>

            <div id="output-column" class="bg-white p-6 rounded-lg shadow-md">
                <nav class="flex border-b mb-4">
                    <button data-target="resposta" class="output-tab active font-semibold py-2 px-4 border-b-2 border-transparent">Resposta</button>
                    <button data-target="historico" class="output-tab font-semibold py-2 px-4 border-b-2 border-transparent">Histórico</button>
                    <button data-target="dna" class="output-tab font-semibold py-2 px-4 border-b-2 border-transparent">Editar DNA</button>
                </nav>

                <div id="panel-resposta" class="output-panel active">
                    <div id="loader" class="hidden mx-auto loader mb-4"></div>
                    <div id="response-content" class="whitespace-pre-line bg-indigo-50 p-4 rounded-md min-h-[400px] text-gray-700">Aguardando um agente ser executado...</div>
                </div>

                <div id="panel-historico" class="output-panel space-y-4 max-h-[600px] overflow-y-auto">
                    <div id="history-content" class="text-sm text-gray-600">Nenhuma geração no histórico.</div>
                </div>

                <div id="panel-dna" class="output-panel">
                     <h3 class="font-bold mb-2">DNA do Agente: <span id="dna-agent-name" class="text-indigo-600">Nenhum selecionado</span></h3>
                     <p class="text-xs text-gray-500 mb-4">Aqui você pode ajustar as instruções do agente para refinar os resultados. As alterações são temporárias.</p>
                     <label class="block text-sm font-medium text-gray-700">Instrução do Sistema (Personalidade):</label>
                     <textarea id="dna-system-prompt" rows="6" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 mt-1"></textarea>
                     <label class="block text-sm font-medium text-gray-700 mt-4">Instrução do Usuário (Tarefa):</label>
                     <textarea id="dna-user-prompt" rows="8" class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 mt-1"></textarea>
                </div>
                 <p class="text-xs text-center text-gray-500 mt-6">"O objetivo com cada agente é ir até ~80% do necessário. Os últimos 20% recomendo fazer manualmente."</p>
            </div>
        </main>
    </div>

    <div id="guia-modal" class="modal"><div class="modal-content"><span class="close-button" id="close-guia-btn">&times;</span><div id="guia-container-corrected" class="max-h-[80vh] overflow-y-auto"></div></div></div>
    <div id="infografico-modal" class="modal"><div class="modal-content"><span class="close-button" id="close-infografico-btn">&times;</span><div id="infografico-container" class="max-h-[80vh] overflow-y-auto"></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = { apiKey: '', history: [], selectedAgent: null };

            const apiKeyInput = document.getElementById('gemini-api-key');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiKeyStatus = document.getElementById('api-key-status');
            const agentAccordionContainer = document.querySelector('.agent-accordion');
            const outputTabs = document.querySelectorAll('.output-tab');
            const outputPanels = document.querySelectorAll('.output-panel');
            const responseContent = document.getElementById('response-content');
            const historyContent = document.getElementById('history-content');
            const dnaAgentName = document.getElementById('dna-agent-name');
            const dnaSystemPrompt = document.getElementById('dna-system-prompt');
            const dnaUserPrompt = document.getElementById('dna-user-prompt');
            const loader = document.getElementById('loader');

            const agentConfigs = {
                'gerador-ideias': {
                    title: "Gerador de Ideias Virais",
                    description: "Insira um tema e receba ideias de vídeos com alto potencial de engajamento.",
                    inputs: [{ id: 'topic-input', label: 'Tema ou palavra-chave:', placeholder: 'Ex: Produtividade', type: 'text' }],
                    getPrompts: (inputs) => ({
                        system: "Você é um estrategista de conteúdo para o YouTube, especialista em identificar tendências e temas com alto potencial de viralização.",
                        user: `Baseado no tema central "${inputs[0]}", gere 5 ideias de vídeos para o YouTube. Para cada ideia, forneça um título provisório e uma breve descrição do conceito, focando em formatos que geram alto engajamento (listas, tutoriais, comparações, storytelling).`
                    })
                },
                'criador-angulos': {
                    title: "Criador de Ângulos Únicos",
                    description: "Cole uma ideia de vídeo e receba abordagens criativas e ganchos para o seu roteiro.",
                    inputs: [{ id: 'angle-input', label: 'Ideia de vídeo para detalhar:', placeholder: 'Ex: 5 hábitos que destruíram minha produtividade', type: 'textarea' }],
                    getPrompts: (inputs) => ({
                        system: "Você é um roteirista e diretor de criação, mestre em transformar ideias boas em vídeos irresistíveis. Seu superpoder é encontrar ângulos únicos e provocativos.",
                        user: `Para a ideia de vídeo "${inputs[0]}", crie 3 ângulos de abordagem distintos e específicos. Para cada ângulo, explique o 'gancho' inicial (os primeiros 15 segundos) e por que ele atrairia a atenção do público.`
                    })
                },
                'mestre-titulos': {
                    title: "Mestre dos Títulos",
                    description: "Forneça o tema do vídeo e receba 5 opções de títulos otimizados para cliques (CTR).",
                    inputs: [{ id: 'title-input', label: 'Tema central do vídeo:', placeholder: 'Ex: Como fazer o melhor bolo de chocolate', type: 'text' }],
                    getPrompts: (inputs) => ({
                        system: "Você é um especialista em SEO para YouTube e copywriting, focado em criar títulos que maximizam a taxa de cliques (CTR). Siga as melhores práticas: menos de 70 caracteres, uso de palavras-chave, números e gatilhos emocionais.",
                        user: `Gere 5 opções de títulos otimizados para um vídeo do YouTube com o seguinte tema: "${inputs[0]}". Os títulos devem ser magnéticos e claros sobre o conteúdo do vídeo.`
                    })
                },
            };

            function initializeAgents() {
                agentAccordionContainer.innerHTML = '';
                for (const agentId in agentConfigs) {
                    const config = agentConfigs[agentId];
                    const inputsHTML = config.inputs.map(input => {
                        const Tag = input.type === 'textarea' ? 'textarea' : 'input';
                        const rows = input.type === 'textarea' ? 'rows="3"' : '';
                        return `<label for="${input.id}" class="block text-sm font-medium text-gray-700 mb-1">${input.label}</label>
                                <${Tag} id="${input.id}" ${rows} class="w-full p-2 border border-gray-300 rounded-md" placeholder="${input.placeholder}"></${Tag}>`;
                    }).join('');
                    agentAccordionContainer.innerHTML += `
                        <details data-agent-id="${agentId}">
                            <summary class="font-bold text-lg">${config.title}</summary>
                            <div class="p-4 border border-t-0 rounded-b-md">
                                <p class="text-sm text-gray-600 mb-4">${config.description}</p>
                                ${inputsHTML}
                                <button data-agent-id="${agentId}" class="agent-generate-btn mt-3 bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors">Gerar Resposta</button>
                            </div>
                        </details>`;
                }
            }

            async function callGeminiAPI(apiKey, systemPrompt, userQuery) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        contents: [{ parts: [{ text: userQuery }] }],
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : 'Erro desconhecido na API.');
                }
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text;
            }

            function updateHistoryView() {
                if (state.history.length === 0) {
                    historyContent.innerHTML = 'Nenhuma geração no histórico.'; return;
                }
                historyContent.innerHTML = state.history.map(item => `
                    <div class="border p-3 rounded-md bg-gray-50">
                        <p class="font-bold text-gray-800">${item.agentTitle}</p>
                        <p class="text-xs text-gray-500 mb-2">Entrada: ${item.inputs.join(', ')}</p>
                        <div class="whitespace-pre-line text-gray-700">${item.response}</div>
                    </div>`).reverse().join('');
            }

            function selectAgent(agentId) {
                state.selectedAgent = agentId;
                const config = agentConfigs[agentId];
                dnaAgentName.textContent = config.title;
                const dummyInputs = config.inputs.map(i => `[${i.label}]`);
                const prompts = config.getPrompts(dummyInputs);
                dnaSystemPrompt.value = prompts.system;
                dnaUserPrompt.value = prompts.user;
            }

            // --- Event Listeners ---
            saveApiKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    state.apiKey = key;
                    apiKeyStatus.textContent = 'Chave salva com sucesso!';
                    setTimeout(() => { apiKeyStatus.textContent = ''; }, 3000);
                }
            });

            apiKeyInput.addEventListener('input', () => { state.apiKey = apiKeyInput.value.trim(); });
            
            outputTabs.forEach(tab => tab.addEventListener('click', () => {
                outputTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                outputPanels.forEach(p => p.classList.remove('active'));
                document.getElementById(`panel-${tab.dataset.target}`).classList.add('active');
            }));

            agentAccordionContainer.addEventListener('click', async (e) => {
                const target = e.target;
                if (target.tagName === 'SUMMARY') {
                    const detailsElement = target.parentElement;
                    if (!detailsElement.hasAttribute('open')) {
                        document.querySelectorAll('.agent-accordion details[open]').forEach(openDetail => {
                            if (openDetail !== detailsElement) openDetail.removeAttribute('open');
                        });
                        selectAgent(detailsElement.dataset.agentId);
                    }
                }
                if (target.classList.contains('agent-generate-btn')) {
                    const agentId = target.dataset.agentId;
                    const config = agentConfigs[agentId];
                    const inputValues = config.inputs.map(input => document.getElementById(input.id).value.trim());
                    if (!state.apiKey || inputValues.some(v => v === '')) {
                        alert('Por favor, insira sua API Key e preencha todos os campos do agente.'); return;
                    }
                    loader.classList.remove('hidden');
                    responseContent.textContent = 'Gerando...';
                    try {
                        let userPromptTemplate = dnaUserPrompt.value;
                        config.inputs.forEach((input, index) => {
                            userPromptTemplate = userPromptTemplate.replace(`[${input.label}]`, inputValues[index]);
                        });
                        const resultText = await callGeminiAPI(state.apiKey, dnaSystemPrompt.value, userPromptTemplate);
                        
                        if (resultText) {
                            responseContent.textContent = resultText.trim();
                            state.history.push({ agentTitle: config.title, inputs: inputValues, response: resultText.trim() });
                            updateHistoryView();
                        } else {
                            throw new Error("A API retornou uma resposta vazia.");
                        }
                    } catch (error) {
                        responseContent.textContent = `Ocorreu um erro: ${error.message}`;
                    } finally {
                        loader.classList.add('hidden');
                    }
                }
            });
            
            // --- Inicialização ---
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                apiKeyInput.value = savedKey;
                state.apiKey = savedKey;
                apiKeyStatus.textContent = 'Chave carregada do seu navegador.';
                setTimeout(() => { apiKeyStatus.textContent = ''; }, 3000);
            }
            initializeAgents();

            // --- Lógica dos Modais ---
            const guiaModal = document.getElementById('guia-modal');
            const infograficoModal = document.getElementById('infografico-modal');
            document.getElementById('open-guia-btn').onclick = () => { guiaModal.style.display = 'block'; };
            document.getElementById('close-guia-btn').onclick = () => { guiaModal.style.display = 'none'; };
            document.getElementById('open-infografico-btn').onclick = () => { infograficoModal.style.display = 'block'; };
            document.getElementById('close-infografico-btn').onclick = () => { infograficoModal.style.display = 'none'; };
            window.onclick = (event) => {
                if (event.target == guiaModal) guiaModal.style.display = "none";
                if (event.target == infograficoModal) infograficoModal.style.display = "none";
            };

            document.querySelector('#guia-container-corrected').innerHTML = `
                <h1 class="text-3xl font-bold mb-4 text-center">Guia de Implementação N8N</h1>
                <p class="text-center mb-4">Este é o guia passo a passo, corrigido e sem erros, para configurar sua automação.</p>
                <div class="text-left"><h2 class="text-xl font-bold mt-4">Parte 1: A Fundação</h2><p>Comece criando sua Planilha Google com as colunas: TEMA, ROTEIRO, STATUS, VIDEO_URL, TIKTOK_URL. Em seguida, no Google Cloud Platform (GCP), crie um novo projeto, ative a "Google Sheets API", configure a "Tela de Consentimento OAuth" como "External" e adicione a si mesmo como "Test user". Finalmente, gere um "OAuth client ID" do tipo "Web application" e use o "Redirect URI" do seu nó do n8n para obter o Client ID e Secret.</p></div>
                <div class="text-left"><h2 class="text-xl font-bold mt-4">Parte 2: Chaves de API</h2><p>Obtenha as chaves de API dos serviços Fal.ai (para geração de vídeo) e Upload-post.com (para publicação). No n8n, armazene-as usando o tipo de credencial "Header Auth", prestando atenção ao prefixo correto ("Key" para Fal.ai, "Apikey" para Upload-post.com).</p></div>
            `;
            document.getElementById('infografico-container').innerHTML = `<h1 class="text-3xl font-bold mb-4 text-center">Infográfico: Fábrica de Vídeos com IA</h1><p class="text-center">Visualização do fluxo de automação, desde o gatilho no N8N até a publicação final no TikTok, incluindo a etapa de geração de título com Gemini.</p><div class="flex justify-center mt-4"><div class="w-full max-w-md"><canvas id="costChart"></canvas></div></div>`;
            const costCanvas = document.getElementById('costChart');
            if(costCanvas) { new Chart(costCanvas.getContext('2d'), { type: 'doughnut', data: { labels: ['API Fal.ai', 'N8N Cloud', 'API Gemini'], datasets: [{ data: [75, 20, 5], backgroundColor: ['#087E8B', '#FF5A5F', '#BFD7EA'] }] } }); }
        });
    </script>
</body>
</html>
